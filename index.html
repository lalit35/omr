<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OMR Sheet Data Extraction</title>
    <script src="https://cdn.jsdelivr.net/npm/opencv.js"></script> <!-- OpenCV.js -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js"></script> <!-- Tesseract.js for OCR -->
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #canvas {
            margin-top: 20px;
            border: 1px solid #000;
            max-width: 100%;
        }
        #result {
            white-space: pre-wrap;
            font-family: monospace;
            margin-top: 20px;
            padding: 10px;
            background-color: #f4f4f4;
            border: 1px solid #ccc;
            border-radius: 5px;
            max-width: 100%;
        }
        #fileInput {
            margin: 10px 0;
        }
        .loading {
            display: none;
            font-weight: bold;
            color: #ff0000;
        }
    </style>
</head>
<body>

<h2>Upload OMR Sheet for Data Extraction</h2>
<input type="file" id="fileInput" accept="image/*">
<div id="fileName">No file selected</div>
<div id="loading" class="loading">Processing the OMR Sheet...</div>
<canvas id="canvas"></canvas>
<div id="result"></div>

<script>
    // Coordinates for extracting key data
    const dataRegions = {
        rollNumber: { x: 240, y: 750, width: 100, height: 50 },
        group: { x: 480, y: 750, width: 100, height: 50 },
        set: { x: 620, y: 750, width: 100, height: 50 },
        mobileNumber: { x: 240, y: 800, width: 200, height: 50 }
    };

    // Coordinates for extracting the answers for each question section
    const questionSections = [
        { x: 284, y: 1640, width: 142, height: 200 },
        { x: 615, y: 1640, width: 118, height: 200 },
        { x: 811, y: 1640, width: 181, height: 200 },
        { x: 1075, y: 1640, width: 181, height: 200 },
        { x: 1339, y: 1640, width: 173, height: 200 }
    ];

    // Handle file input
    document.getElementById('fileInput').addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            document.getElementById('fileName').innerText = `Uploaded file: ${file.name}`;
            const reader = new FileReader();
            reader.onload = function (e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function () {
                    processImage(img);
                };
            };
            reader.readAsDataURL(file);
        }
    });

    // Process the image
    function processImage(img) {
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);

        // Initialize OpenCV.js and process the image
        const mat = cv.imread(canvas);
        cv.cvtColor(mat, mat, cv.COLOR_RGBA2GRAY);  // Convert to grayscale
        cv.adaptiveThreshold(mat, mat, 255, cv.ADAPTIVE_THRESH_MEAN_C, cv.THRESH_BINARY, 11, 2);  // Thresholding

        extractData(mat);  // Extract data after processing the image
    }

    // Extract key data (roll number, group, set, mobile number)
    function extractData(mat) {
        const dataPromises = Object.keys(dataRegions).map(key => {
            const region = dataRegions[key];
            const croppedImage = mat.roi(new cv.Rect(region.x, region.y, region.width, region.height));
            const dataUrl = cv.imencode('.png', croppedImage).toString('base64');
            return extractTextFromRegion('data:image/png;base64,' + dataUrl);
        });

        Promise.all(dataPromises)
            .then(allData => {
                const extractedData = {
                    rollNumber: allData[0],  // Extracted roll number
                    group: allData[1],       // Extracted group
                    set: allData[2],         // Extracted set
                    mobileNumber: allData[3] // Extracted mobile number
                };

                // Process the question sections
                const answers = questionSections.map((section, index) => {
                    return extractAnswers(mat, section, index + 1);
                });

                // Wait until all answers are extracted and display results
                Promise.all(answers).then(allAnswers => {
                    displayResults(extractedData, allAnswers);
                });

                mat.delete();  // Clean up
            })
            .catch(error => {
                console.error('Error extracting data:', error);
            });
    }

    // Extract answer choices (A, B, C, D) for each question section
    function extractAnswers(mat, section, sectionIndex) {
        const { x, y, width, height } = section;
        const croppedSection = mat.roi(new cv.Rect(x, y, width, height));
        cv.cvtColor(croppedSection, croppedSection, cv.COLOR_RGBA2GRAY);
        cv.threshold(croppedSection, croppedSection, 128, 255, cv.THRESH_BINARY);

        const answers = [];
        for (let i = 0; i < 20; i++) {
            const options = ['A', 'B', 'C', 'D'].map(option => checkFilledBubble(croppedSection, i, option));
            answers.push({
                question: (sectionIndex - 1) * 20 + i + 1,
                A: options[0],
                B: options[1],
                C: options[2],
                D: options[3]
            });
        }

        return answers;
    }

    // Check if a bubble is filled for a specific question
    function checkFilledBubble(sectionImage, questionIndex, option) {
        const bubbleCoordinates = getBubbleCoordinates(option, questionIndex);
        const bubble = sectionImage.roi(new cv.Rect(bubbleCoordinates.x, bubbleCoordinates.y, 20, 20));
        const meanColor = cv.mean(bubble);
        bubble.delete();
        return meanColor[0] < 100; // Return true if the bubble is filled (darker color)
    }

    // Get the coordinates for a specific bubble (A, B, C, D) for a question
    function getBubbleCoordinates(option, questionIndex) {
        const bubbleSpacing = 40;
        const baseX = 50;
        const baseY = 40 * questionIndex;
        const offsets = { A: 0, B: 40, C: 80, D: 120 };
        return { x: baseX + offsets[option], y: baseY };
    }

    // Extract text from image region using Tesseract.js
    function extractTextFromRegion(image, region) {
        return new Promise((resolve, reject) => {
            const imgElement = document.createElement('img');
            imgElement.src = image;
            imgElement.onload = function () {
                Tesseract.recognize(
                    imgElement,
                    'eng',
                    {
                        logger: m => console.log(m)
                    }
                ).then(({ data: { text } }) => {
                    resolve(text.trim());
                }).catch(err => reject(err));
            };
        });
    }

    // Display the extracted results on the page
    function displayResults(extractedData, allAnswers) {
        const resultDiv = document.getElementById('result');
        let resultText = 'Extracted Data:\n\n';
        resultText += `Roll Number: ${extractedData.rollNumber}\n`;
        resultText += `Group: ${extractedData.group}\n`;
        resultText += `Set: ${extractedData.set}\n`;
        resultText += `Mobile Number: ${extractedData.mobileNumber}\n\n`;

        resultText += 'Extracted Answers:\n\n';
        allAnswers.forEach((sectionAnswers, sectionIndex) => {
            resultText += `Section ${sectionIndex + 1} Answers:\n`;
            sectionAnswers.forEach(answer => {
                resultText += `  Question ${answer.question}: A=${answer.A}, B=${answer.B}, C=${answer.C}, D=${answer.D}\n`;
            });
        });

        resultDiv.textContent = resultText;
        document.getElementById('loading').style.display = 'none'; // Hide loading text after processing
    }

    // Show loading text while processing
    function showLoading() {
        document.getElementById('loading').style.display = 'block';
    }
</script>

</body>
</html>
